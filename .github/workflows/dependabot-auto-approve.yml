name: Dependabot auto-approve
on: 
  pull_request:
    types:
      - synchronize
      - opened
  check_suite:
    types:
      - completed

permissions:
  pull-requests: write
  checks: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    steps:
      - name: Wait for all checks
        id: checks
        uses: actions/github-script@v7
        with:
          script: |
            const { context } = require('@actions/github');
            const checks = await context.octokit.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
            });
            return checks.data.check_runs.every(check => check.conclusion === 'success');
      - name: Approve PR if all checks pass
        if: steps.checks.outputs.result == 'true'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
